{{ define "main" }}
<!-- Reading Progress Bar -->
<div id="readingProgress" class="reading-progress">
    <div id="readingProgressBar" class="reading-progress-bar"></div>
</div>

<article class="post">
    <div class="container">
        <header class="post-header">
            <div class="post-meta">
                <time datetime="{{ .Date.Format "2006-01-02" }}">{{ .Date.Format "2/1/2006" }}</time>
                {{ range .Params.categories }}
                <span class="post-category">{{ . }}</span>
                {{ end }}
            </div>
            <h1 class="post-title">{{ .Title }}</h1>
            {{ if .Params.description }}
            <p class="post-description">{{ .Params.description }}</p>
            {{ end }}
            <div class="post-tags">
                {{ range .Params.tags }}
                <span class="tag">{{ . }}</span>
                {{ end }}
            </div>
        </header>
        
        <div class="post-content">
            {{ .Content }}
        </div>
        
        <footer class="post-footer">
            <div class="post-navigation">
                {{ with .PrevInSection }}
                <a href="{{ .RelPermalink }}" class="nav-link prev">
                    <span class="nav-direction">← Bài trước</span>
                    <span class="nav-title">{{ .Title }}</span>
                </a>
                {{ end }}
                
                {{ with .NextInSection }}
                <a href="{{ .RelPermalink }}" class="nav-link next">
                    <span class="nav-direction">Bài tiếp →</span>
                    <span class="nav-title">{{ .Title }}</span>
                </a>
                {{ end }}
            </div>
            
            <div class="post-share">
                {{ partial "social-sharing.html" . }}
            </div>
            
            <!-- Related Posts Section -->
            <div class="related-posts">
                <h4>Bài viết liên quan</h4>
                <div class="related-posts-grid">
                    {{ $relatedPosts := where (where .Site.RegularPages "Section" "blog") "Title" "!=" .Title }}
                    {{ $currentCategories := .Params.categories }}
                    {{ $currentTags := .Params.tags }}
                    
                    {{ $relatedByCategory := slice }}
                    {{ $relatedByTags := slice }}
                    
                    {{ range $relatedPosts }}
                        {{ $hasCommonCategory := false }}
                        {{ $hasCommonTag := false }}
                        
                        {{ range $currentCategories }}
                            {{ if in $.Params.categories . }}
                                {{ $hasCommonCategory = true }}
                            {{ end }}
                        {{ end }}
                        
                        {{ range $currentTags }}
                            {{ if in $.Params.tags . }}
                                {{ $hasCommonTag = true }}
                            {{ end }}
                        {{ end }}
                        
                        {{ if $hasCommonCategory }}
                            {{ $relatedByCategory = $relatedByCategory | append . }}
                        {{ else if $hasCommonTag }}
                            {{ $relatedByTags = $relatedByTags | append . }}
                        {{ end }}
                    {{ end }}
                    
                    {{ $finalRelated := slice }}
                    {{ $finalRelated = $finalRelated | append (first 2 $relatedByCategory) }}
                    {{ $finalRelated = $finalRelated | append (first 2 $relatedByTags) }}
                    {{ $finalRelated = $finalRelated | uniq | first 3 }}
                    
                    {{ range $finalRelated }}
                    <article class="related-post-card">
                        <div class="related-post-content">
                            <div class="related-post-meta">
                                {{ range first 1 .Params.categories }}
                                <span class="related-post-category">{{ . }}</span>
                                {{ end }}
                                <time datetime="{{ .Date.Format "2006-01-02" }}">{{ .Date.Format "2/1/2006" }}</time>
                            </div>
                            <h5 class="related-post-title">
                                <a href="{{ .RelPermalink }}">{{ .Title }}</a>
                            </h5>
                            <p class="related-post-excerpt">{{ .Summary | truncate 100 }}</p>
                            <div class="related-post-tags">
                                {{ range first 3 .Params.tags }}
                                <span class="related-tag">{{ . }}</span>
                                {{ end }}
                            </div>
                        </div>
                    </article>
                    {{ end }}
                </div>
            </div>
            
            <!-- Comments Section -->
            <div class="comments-wrapper">
                {{ partial "comments.html" . }}
            </div>
        </footer>
    </div>
</article>
{{ end }}
